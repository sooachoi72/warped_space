<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Warped Space - Gravity Visualization</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Pretendard', sans-serif; }
        
        #ui-layer { position: absolute; top: 20px; left: 20px; z-index: 10; color: white; pointer-events: none; text-shadow: 0 0 10px rgba(0,0,0,0.8); }
        
        h1 { margin: 0 0 10px 0; font-weight: 300; font-size: 1.5rem; letter-spacing: 2px; }
        .controls-info { font-size: 0.8rem; opacity: 0.7; line-height: 1.6; }
        
        #btn-container { pointer-events: auto; margin-top: 20px; display: flex; gap: 10px; }
        
        button { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 10px 20px; border-radius: 30px; cursor: pointer; backdrop-filter: blur(5px); transition: all 0.3s; font-size: 0.9rem; }
        button:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.05); }
        button.active { background: #ff8800; border-color: #ff8800; color: black; font-weight: bold; }
        button:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
        
        #btn-reset { border-color: #ff4444; color: #ffcccc; }
        #btn-reset:hover { background: rgba(255, 68, 68, 0.3); }
        
        #mass-count { margin-top: 10px; font-size: 0.8rem; color: #ff8800; }
        
        #context-menu { display: none; position: absolute; z-index: 100; background: rgba(0, 0, 0, 0.8); border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); padding: 5px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        
        #btn-delete-mass { background: transparent; border: none; color: #ff6666; padding: 8px 15px; font-size: 0.9rem; cursor: pointer; width: 100%; text-align: left; }
        #btn-delete-mass:hover { background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
    </style>
</head>
<body>
    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.164.1/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.164.1/examples/jsm/" } } </script>
    <div id="context-menu"><button id="btn-delete-mass">ğŸ—‘ï¸ Delete Mass</button></div>
    <div id="ui-layer">
        <h1>WARPED SPACE</h1>
        <div class="controls-info">
            <b>View Mode:</b> <span id="view-mode-text">GOD MODE</span><br>
            <b>Interaction:</b> Click 'Add Mass' -> Hold & Release<br>
            <b>Delete:</b> Right-Click on Mass<br>
            <b>Move (FPS):</b> W, A, S, D (Thrust)<br>
            <b>Look (FPS):</b> Drag Mouse
        </div>
        <div id="mass-count">Masses: 0 / 5</div>
        <div id="btn-container">
            <button id="btn-toggle-view">Switch View</button>
            <button id="btn-add-mass">âœš Add Mass</button>
            <button id="btn-reset">â†º Reset All</button>
        </div>
    </div>
    <canvas id="webgl"></canvas>

    <script id="vertexShader" type="x-shader/x-vertex">
        uniform float uTime; 
        uniform int uMassCount; 
        uniform vec3 uMassPositions[5]; 
        uniform float uMassValues[5]; 
        uniform float uK; 
        uniform float uEpsilon;
        
        varying float vHeight; 
        varying vec2 vUv; 
        varying vec3 vWorldPosition;
        
        void main() {
        vUv = uv;
        vec3 newPos = position;
        vec4 worldPosition = modelMatrix * vec4(position, 1.0);
        
        float displacement = 0.0;
        
        vec3 pull = vec3(0.0); 

        for(int i = 0; i < 5; i++) {
            if(i >= uMassCount) break;

            float dx = worldPosition.x - uMassPositions[i].x;
            float dz = worldPosition.z - uMassPositions[i].z;
            float r = sqrt(dx * dx + dz * dz + uEpsilon * uEpsilon);
            
            float force = -uK * (uMassValues[i] / r);
            displacement += force;

            // ê¹Šì´ê°€ ê¹Šì„ìˆ˜ë¡(forceê°€ ê°•í• ìˆ˜ë¡) ë” ê°•í•˜ê²Œ ë‹¹ê¹€
            float pullFactor = force * 0.2; // ë‹¹ê¸°ëŠ” ê°•ë„ ì¡°ì ˆ
            pull.x += (dx / r) * pullFactor; // Xì¶• ë‹¹ê¹€
            pull.y += (dz / r) * pullFactor; // Zì¶•(ì½”ë“œìƒ y) ë‹¹ê¹€
        }

        // ê°€ì¥ìë¦¬ ë¶€ë“œëŸ½ê²Œ
        float distFromCenter = length(worldPosition.xz);
        float edgeFactor = 1.0 - smoothstep(350.0, 490.0, distFromCenter);
        
        displacement *= edgeFactor;
        pull *= edgeFactor; // ë‹¹ê¸°ëŠ” í˜ë„ ê°€ì¥ìë¦¬ì—ì„  ì•½í•˜ê²Œ

        // ì¢Œí‘œ ì ìš©
        newPos.z += displacement; // ì•„ë˜ë¡œ êº¼ì§
        newPos.x += pull.x;       // ì˜†ìœ¼ë¡œ ë¹¨ë ¤ê° 
        newPos.y -= pull.y;       // ìœ„ì•„ë˜ë¡œ ë¹¨ë ¤ê°

        vHeight = displacement;
        vWorldPosition = (modelMatrix * vec4(newPos, 1.0)).xyz;

        gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(newPos, 1.0);
    }
    </script>

    <script id="fragmentShader" type="x-shader/x-fragment">
        varying float vHeight; varying vec2 vUv; varying vec3 vWorldPosition;
        uniform vec3 uGridColor; uniform vec3 uBaseColor; uniform float uGridScale;
        void main() {
        vec2 gridUV = vUv * uGridScale; 
        vec2 grid = abs(fract(gridUV - 0.5) - 0.5) / fwidth(gridUV);
        float line = min(grid.x, grid.y);
        float gridIntensity = 1.0 - min(line, 1.0);

        float depth = clamp(abs(vHeight) * 0.05, 0.0, 1.0); 
        
        vec3 targetColor = vec3(1.0, 0.5, 0.1); 
        
        vec3 depthColor = mix(uGridColor, targetColor, depth * 0.5); 

        vec3 finalColor = mix(uBaseColor, depthColor, gridIntensity);
        
        float glowFactor = 0.3 + depth * 0.5;
        finalColor += depthColor * gridIntensity * glowFactor; 

        float dist = length(vWorldPosition.xz);
        float fade = 1.0 - smoothstep(300.0, 500.0, dist); 
        
        gl_FragColor = vec4(finalColor * fade, 1.0);
    }
    </script>
    <script type="module" src="main.js"></script>
</body>
</html>